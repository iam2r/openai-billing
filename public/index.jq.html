<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>OpenAI Billing</title>
    <meta name="theme-color" media="(prefers-color-scheme: light)" content="#fafafa">
    <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#fafafa">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="OpenAI Billing">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <link rel="manifest" href="/site.webmanifest" />
    <link rel="stylesheet" href="/index.css">
    <script src="/serviceWorkerRegister.js" defer></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

</head>

<body>
    <div id="root"></div>

    <script>
        $(document).ready(function () {
            // åˆå§‹åŒ–çŠ¶æ€
            var urlList = [
                {
                    name: "ã€vecelåä»£çº¿è·¯ã€‘",
                    value: "https://proxy.vercel.iamrazo.pro/api.openai.com",
                },
                {
                    name: "ã€å®˜ç½‘çº¿è·¯ã€‘",
                    value: "https://api.openai.com",
                },
                {
                    name: "è‡ªå®šä¹‰ ...",
                    value: "custom",
                },
            ];
            var apiKeyInput = "sess-trdTXEzS6xUyYgMiIabKwZ9M9Gpc8NDxrdYmPdNA";
            var apiUrlSelect = urlList[0].value;
            var customUrlInput = "";
            var loading = false;
            var result = [];

            function bindEvent() {
                // ç›‘å¬ API KEY è¾“å…¥æ¡†çš„å˜åŒ–
                $("#api-key-input").on("input", function () {
                    apiKeyInput = $(this).val();
                });

                // ç›‘å¬ API URL é€‰æ‹©æ¡†çš„å˜åŒ–
                $("#api-url-select").change(function () {
                    apiUrlSelect = $(this).val();
                    if (apiUrlSelect === "custom") {
                        $("#custom-url-input").show();
                    } else {
                        $("#custom-url-input").hide();
                    }
                });

                // ç›‘å¬è‡ªå®šä¹‰ URL è¾“å…¥æ¡†çš„å˜åŒ–
                $("#custom-url-input").on("input", function () {
                    customUrlInput = $(this).val();
                });

                // ç›‘å¬æŸ¥è¯¢æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶
                $("#query-button").click(function () {
                    sendRequest();
                });

            }
            // å‘é€è¯·æ±‚
            function sendRequest() {
                setLoading(true);
                setResult([]);

                if (apiKeyInput.trim() === "") {
                    alert("è¯·å¡«å†™API KEY");
                    setLoading(false);
                    return;
                }

                var apiUrl = "";
                if (apiUrlSelect === "custom") {
                    if (customUrlInput.trim() === "") {
                        alert("è¯·è®¾ç½®APIé“¾æ¥");
                        setLoading(false);
                        return;
                    } else {
                        apiUrl = customUrlInput.trim();
                        if (!apiUrl.startsWith("http://") && !apiUrl.startsWith("https://")) {
                            apiUrl = "https://" + apiUrl;
                        }
                    }
                } else {
                    apiUrl = apiUrlSelect;
                }

                var apiKeys = apiKeyInput.split(",");
                if (apiKeys.length === 0) {
                    alert("æœªåŒ¹é…åˆ° API-KEYï¼Œè¯·æ£€æŸ¥è¾“å…¥å†…å®¹");
                    setLoading(false);
                    return;
                }

                alert("æˆåŠŸåŒ¹é…åˆ° API Keyï¼Œç¡®è®¤åå¼€å§‹æŸ¥è¯¢ï¼š" + apiKeys);

                // é€ä¸ªæŸ¥è¯¢ API KEY
                var promises = apiKeys.map(function (apiKey) {
                    return checkBilling(apiKey, apiUrl).catch(function () {
                        // é”™è¯¯å¤„ç†
                    });
                });

                // å¹¶è¡Œæ‰§è¡Œæ‰€æœ‰æŸ¥è¯¢
                $.when.apply($, promises)
                    .then(function () {
                        var queriedApiKeys = Array.from(arguments);
                        setResult(queriedApiKeys.filter(Boolean));
                    })
                    .catch(function (error) {
                        console.error(error);
                    })
                    .always(function () {
                        setLoading(false);
                    });
            }

            // æŸ¥è¯¢è´¦å•
            function checkBilling(apiKey, apiUrl) {
                var now = new Date();
                var startDate = new Date(now - 90 * 24 * 60 * 60 * 1000);
                var endDate = new Date(now.getTime() + 24 * 60 * 60 * 1000);
                var subDate = new Date(now);
                subDate.setDate(1);

                var headers = {
                    Authorization: "Bearer " + apiKey,
                    "Content-Type": "application/json",
                };
                var gpt4Check = apiUrl + "/v1/models";
                var urlSubscription = apiUrl + "/v1/dashboard/billing/subscription";
                var urlUsage =
                    apiUrl +
                    "/v1/dashboard/billing/usage?start_date=" +
                    formatDate(startDate) +
                    "&end_date=" +
                    formatDate(endDate);

                return $.ajax({
                    url: urlSubscription,
                    headers: headers,
                    method: "GET",
                })
                    .then(function (response) {
                        if (!response.ok) {
                            return {
                                apiKey: apiKey,
                                error: "APIKEY é”™è¯¯æˆ–è´¦å·è¢«å°ï¼Œè¯·ç™»å½• OpenAI æŸ¥çœ‹ã€‚",
                            };
                        }

                        var currentDate = new Date();
                        var subscriptionData = response;
                        var totalAmount = subscriptionData.system_hard_limit_usd;
                        var expiryDate = new Date(
                            subscriptionData.access_until * 1000 + 8 * 60 * 60 * 1000
                        );
                        var formattedDate =
                            expiryDate.getFullYear() +
                            "-" +
                            (expiryDate.getMonth() + 1).toString().padStart(2, "0") +
                            "-" +
                            expiryDate.getDate().toString().padStart(2, "0");

                        return $.ajax({
                            url: gpt4Check,
                            headers: headers,
                            method: "GET",
                        }).then(function (gpt4CheckResponse) {
                            var gpt4CheckData = gpt4CheckResponse;
                            var isGPT4 =
                                Array.isArray(gpt4CheckData.data) &&
                                gpt4CheckData.data.some(function (item) {
                                    return item.id.includes("gpt-4");
                                });
                            var isSubscrible = subscriptionData.plan.id.includes("payg");

                            if (totalAmount > 20) {
                                urlUsage =
                                    apiUrl +
                                    "/v1/dashboard/billing/usage?start_date=" +
                                    formatDate(subDate) +
                                    "&end_date=" +
                                    formatDate(endDate);
                            }

                            return $.ajax({
                                url: urlUsage,
                                headers: headers,
                                method: "GET",
                            }).then(function (usageResponse) {
                                var usageData = usageResponse;
                                var totalUsage = usageData.total_usage / 100;
                                var remaining =
                                    subscriptionData.system_hard_limit_usd - totalUsage;
                                var isExpired = currentDate > expiryDate;

                                return {
                                    apiKey: apiKey,
                                    totalAmount: totalAmount,
                                    totalUsage: totalUsage,
                                    remaining: remaining,
                                    formattedDate: formattedDate,
                                    isExpired: isExpired,
                                    isGPT4: isGPT4,
                                    isSubscrible: isSubscrible,
                                };
                            });
                        });
                    })
                    .catch(function (error) {
                        console.error(error);
                    });
            }

            // æ ¼å¼åŒ–æ—¥æœŸ
            function formatDate(date) {
                var year = date.getFullYear();
                var month = (date.getMonth() + 1).toString().padStart(2, "0");
                var day = date.getDate().toString().padStart(2, "0");

                return year + "-" + month + "-" + day;
            }

            // é®ç›– API KEY
            function maskAPIKey(apiKey) {
                var strList = apiKey.split("");
                var start = 0 + 8;
                var end = Math.max(strList.length - 1 - 5, start);

                return strList
                    .map(function (it, index) {
                        if (index > start && index < end) return "";
                        if (index === start || index === end) return "*";
                        return it;
                    })
                    .join("");
            }

            // è®¾ç½®åŠ è½½çŠ¶æ€
            function setLoading(isLoading) {
                loading = isLoading;
                if (loading) {
                    $("#query-button").addClass("loading").attr("disabled", true);
                } else {
                    $("#query-button").removeClass("loading").attr("disabled", false);
                }
            }

            // è®¾ç½®æŸ¥è¯¢ç»“æœ
            function setResult(data) {
                result = data;
                if (result.length > 0) {
                    $("#result-head").show();
                    $("#result-table-container").show();

                    var tableBody = $("#result-table tbody");
                    tableBody.empty();

                    result.forEach(function (item, index) {
                        if (item.error) {
                            tableBody.append(
                                $("<tr>").append(
                                    $("<td>").text(maskAPIKey(item.apiKey)),
                                    $("<td>").attr("colspan", 6).text(item.error)
                                )
                            );
                        } else {
                            tableBody.append(
                                $("<tr>").append(
                                    $("<td>").text(maskAPIKey(item.apiKey)),
                                    $("<td>").text(item.totalAmount.toFixed(2)),
                                    $("<td>").text(item.totalUsage.toFixed(2)),
                                    $("<td>").text(item.remaining.toFixed(2)),
                                    $("<td>").text(
                                        item.formattedDate +
                                        " " +
                                        (item.isExpired ? "(ğŸ”´)" : "(ğŸŸ¢)")
                                    ),
                                    $("<td>").text(item.isGPT4 ? "âœ…" : "âŒ"),
                                    $("<td>").text(item.isSubscrible ? "ğŸŸ¢" : "ğŸ”´")
                                )
                            );
                        }
                    });
                } else {
                    $("#result-head").hide();
                    $("#result-table-container").hide();
                }
            }

            // æ¸²æŸ“é¡µé¢
            function render() {
                var rootElement = $("#root");
                rootElement.empty();

                var header = $("<header>").append(
                    $("<h1>")
                        .addClass("text-3xl font-semibold text-center mb-8 text-gradient")
                        .text("æŸ¥è¯¢ OpenAI è´¦å•")
                );

                var apiKeyInput = $("<textarea>")
                    .attr("id", "api-key-input")
                    .attr("placeholder", "è¯·è¾“å…¥ API-KEYï¼Œå¤šä¸ªè¯·ç”¨è‹±æ–‡é€—å·,éš”å¼€");

                var apiUrlSelect = $("<select>")
                    .attr("id", "api-url-select")
                    .change(function () {
                        handleApiUrlChange();
                    });

                urlList.forEach(function (item) {
                    apiUrlSelect.append($("<option>").val(item.value).text(item.name));
                });

                var customUrlInput = $("<input>")
                    .attr("type", "text")
                    .attr("id", "custom-url-input")
                    .attr("placeholder", "è¾“å…¥è‡ªå®šä¹‰APIï¼Œé»˜è®¤ä½¿ç”¨ https åè®®")
                    .hide();

                var queryButton = $("<button>")
                    .attr("id", "query-button")
                    .text("æŸ¥è¯¢")
                 

                var resultHead = $("<h2>").attr("id", "result-head").hide().text("æŸ¥è¯¢ç»“æœ");

                var resultTableContainer = $("<div>")
                    .attr("id", "result-table-container")
                    .css({ width: "100%", overflowX: "auto" })
                    .hide();

                var resultTable = $("<table>").attr("id", "result-table");

                var tableHead = $("<thead>").append(
                    $("<tr>").append(
                        $("<th>").text("API KEY"),
                        $("<th>").text("æ€»é¢åº¦"),
                        $("<th>").text("å·²ä½¿ç”¨"),
                        $("<th>").text("å‰©ä½™é‡"),
                        $("<th>").text("åˆ°æœŸæ—¶é—´"),
                        $("<th>").text("GPT-4"),
                        $("<th>").text("æ˜¯å¦ç»‘å¡")
                    )
                );

                var tableBody = $("<tbody>");

                resultTable.append(tableHead, tableBody);
                resultTableContainer.append(resultTable);

                rootElement.append(
                    header,
                    $("<h2>").text("è¾“å…¥ API KEY"),
                    apiKeyInput,
                    $("<h2>").text("é€‰æ‹©æŸ¥è¯¢çº¿è·¯"),
                    $("<p>").text("æ”¯æŒè‡ªå®šä¹‰çº¿è·¯"),
                    apiUrlSelect,
                    customUrlInput,
                    queryButton,
                    resultHead,
                    resultTableContainer
                );
            }

            // ç›‘å¬ API URL é€‰æ‹©æ¡†çš„å˜åŒ–
            function handleApiUrlChange() {
                apiUrlSelect = $("#api-url-select").val();
                if (apiUrlSelect === "custom") {
                    $("#custom-url-input").show();
                } else {
                    $("#custom-url-input").hide();
                }
            }

            render();

            bindEvent()
        });
    </script>
</body>

</html>